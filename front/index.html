<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Alarmas</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
</head>
<body>
  <div class="navbar">
    <a href="index.html" class="active">Alertas</a>
    <a href="alarmas.html">Alarmas</a>
    <button class="logout-btn" style="margin-left:auto; margin-right:0;" onclick="logout()"><i class="fa fa-sign-out-alt"></i> Cerrar sesión</button>
  </div>
  <div class="main-layout" style="height:100vh; display:flex; flex-direction:row;">
    <!-- Alertas activas -->
    <div id="alertasActivas" style="width:340px; min-width:240px; max-width:380px; background:#fff; border-right:1px solid #ddd; display:flex; flex-direction:column;">
      <h2 style="margin:12px 0 0 12px; font-size:1.2em;">Alertas Activas</h2>
      <button id="btnCrearAlertaPrueba" onclick="mostrarFormularioAlertaPrueba()">Crear alerta de prueba</button>
      <div id="formAlertaPrueba" style="display:none; padding:10px 8px 0 8px;">
        <form onsubmit="event.preventDefault(); crearAlertaPrueba();">
          <input id="usuarioAlertaPrueba" placeholder="Usuario" style="width:100%;margin-bottom:6px;" required>
          <input id="latAlertaPrueba" type="number" step="any" placeholder="Latitud" style="width:48%;margin-right:4%;" required>
          <input id="lngAlertaPrueba" type="number" step="any" placeholder="Longitud" style="width:48%;" required>
          <button type="submit" style="width:100%;margin-top:6px;">Crear</button>
          <button type="button" style="width:100%;margin-top:4px;background:#888;" onclick="ocultarFormularioAlertaPrueba()">Cancelar</button>
        </form>
      </div>
      <div id="alertasList" style="flex:1 1 auto; overflow-y:auto; padding:8px 8px 16px 8px;"></div>
    </div>
    <!-- Mapa -->
    <div style="flex:1 1 0; position:relative;">
      <div id="map" style="position:absolute; top:0; left:0; right:0; bottom:0;"></div>
      <div id="detalleAlerta" style="display:none; position:absolute; top:20px; right:20px; background:#fff; border-radius:8px; box-shadow:0 2px 8px #0002; padding:18px 22px; min-width:260px; z-index:1000;"></div>
    </div>
  </div>
  <script>
    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDpHOc0setZG5aSqrbBvXZ-Yf0zkgNfrT0",
      authDomain: "controlledesp32-2afc2.firebaseapp.com",
      projectId: "controlledesp32-2afc2",
      storageBucket: "controlledesp32-2afc2.appspot.com",
      messagingSenderId: "873706050350",
      appId: "1:873706050350:web:d616c15e2649391d4720bf"
    };
    firebase.initializeApp(firebaseConfig);
    let idToken = null;
    let map, alertaMarker;
    let alertaSeleccionada = null;

    function showLogin() {
      document.getElementById('loginPage').style.display = '';
      document.querySelector('.main-layout').style.display = 'none';
    }
    function showMain() {
      document.getElementById('loginPage').style.display = 'none';
      document.querySelector('.main-layout').style.display = '';
      setTimeout(initMap, 100);
      listarAlertas();
    }
    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(userCredential => userCredential.user.getIdToken())
        .then(token => {
          idToken = token;
          showMain();
        })
        .catch(e => alert('Error: ' + e.message));
    }
    function logout() {
      firebase.auth().signOut();
      idToken = null;
      showLogin();
    }
    function getHeaders() {
      if (!idToken) { alert('Primero inicia sesión.'); throw new Error('No token'); }
      return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + idToken };
    }
    // Alertas
    function listarAlertas() {
      fetch('http://127.0.0.1:8000/alertas', { headers: getHeaders() })
        .then(r => r.json()).then(data => {
          const list = document.getElementById('alertasList');
          list.innerHTML = '';
          // Limpiar marcadores previos
          if (window.pendientesMarkers) {
            window.pendientesMarkers.forEach(m => m.remove());
          }
          window.pendientesMarkers = [];
          data.forEach(a => {
            if (a.estado === 'pendiente') {
              const card = document.createElement('div');
              card.className = 'alerta-card';
              card.innerHTML = `
                <div><b>Usuario:</b> ${a.usuarioId || ''}</div>
                <div><b>Ubicación:</b> ${(a.ubicacion && a.ubicacion.join) ? a.ubicacion.join(', ') : ''}</div>
                <div style='margin-top:8px; display:flex; gap:8px;'>
                  <button class='btn-ver-mapa' data-id='${a.id || ''}'>Ver en el mapa</button>
                  <button class='btn-atendida' data-id='${a.id || ''}' style='background:#2d8cf0; color:#fff;'>Alerta atendida</button>
                </div>
              `;
              list.appendChild(card);
            }
          });
          // Asignar eventos después de renderizar
          document.querySelectorAll('.btn-ver-mapa').forEach(btn => {
            btn.onclick = function(e) {
              e.stopPropagation();
              const id = this.getAttribute('data-id');
              const alerta = data.find(a => a.id === id);
              if (alerta && window.map && Array.isArray(alerta.ubicacion) && !isNaN(alerta.ubicacion[0]) && !isNaN(alerta.ubicacion[1])) {
                if (window.alertaMarker) window.alertaMarker.remove();
                window.alertaMarker = L.marker([alerta.ubicacion[0], alerta.ubicacion[1]], {
                  icon: L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                    iconSize: [38, 38],
                    iconAnchor: [19, 38],
                    popupAnchor: [0, -38]
                  })
                }).addTo(window.map).bindPopup(`<b>${alerta.usuarioId}</b><br>${alerta.ubicacion.join(', ')}`);
                window.map.setView([alerta.ubicacion[0], alerta.ubicacion[1]], 16);
                window.alertaMarker.openPopup();
              }
            };
          });
          document.querySelectorAll('.btn-atendida').forEach(btn => {
            btn.onclick = function(e) {
              e.stopPropagation();
              const id = this.getAttribute('data-id');
              if (id) marcarAtendida(id);
            };
          });
          // Agregar marcadores al mapa DESPUÉS de renderizar todas las tarjetas
          data.forEach(a => {
            if (a.estado === 'pendiente' && window.map && Array.isArray(a.ubicacion) && !isNaN(a.ubicacion[0]) && !isNaN(a.ubicacion[1])) {
              const marker = L.marker([a.ubicacion[0], a.ubicacion[1]], {
                icon: L.icon({
                  iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                  iconSize: [32, 32],
                  iconAnchor: [16, 32],
                  popupAnchor: [0, -32]
                })
              }).addTo(window.map).bindPopup(`<b>${a.usuarioId}</b><br>${a.ubicacion.join(', ')}`);
              window.pendientesMarkers.push(marker);
            }
          });
        });
    }
    function verDetallesAlerta(id) {
      fetch(`http://127.0.0.1:8000/alertas/${id}`, { headers: getHeaders() })
        .then(r => r.json()).then(a => {
          alertaSeleccionada = a;
          const detalle = document.getElementById('detalleAlerta');
          detalle.innerHTML = `
            <h3>Detalles de la Alerta</h3>
            <div><b>ID:</b> ${a.id || ''}</div>
            <div><b>Usuario:</b> ${a.usuarioId}</div>
            <div><b>Estado:</b> ${a.estado}</div>
            <div><b>Ubicación:</b> ${a.ubicacion.join(', ')}</div>
            <div><b>Fecha:</b> ${a.timestamp ? new Date(a.timestamp).toLocaleString() : ''}</div>
            <button style='margin-top:12px;' onclick='cerrarDetallesAlerta()'>Cerrar</button>
          `;
          detalle.style.display = '';
          if (map && a.ubicacion && !isNaN(a.ubicacion[0]) && !isNaN(a.ubicacion[1])) {
            if (alertaMarker) alertaMarker.remove();
            alertaMarker = L.marker([a.ubicacion[0], a.ubicacion[1]]).addTo(map);
            map.setView([a.ubicacion[0], a.ubicacion[1]], 16);
          }
        });
    }
    function cerrarDetallesAlerta() {
      document.getElementById('detalleAlerta').style.display = 'none';
      alertaSeleccionada = null;
    }
    function marcarAtendida(id) {
      // Obtener la alerta completa antes de actualizar
      fetch(`http://127.0.0.1:8000/alertas/${id}`, { headers: getHeaders() })
        .then(r => r.json())
        .then(alerta => {
          alerta.estado = 'atendida';
          // Forzar método PUT usando fetch correctamente
          return fetch(`http://127.0.0.1:8000/alertas/${id}`, {
            method: 'PUT',
            headers: getHeaders(),
            body: JSON.stringify(alerta)
          })
          .then(resp => {
            if (!resp.ok) throw new Error('Error al actualizar la alerta');
            return resp.json();
          });
        })
        .then(() => { listarAlertas(); cerrarDetallesAlerta(); })
        .catch(e => alert('Error al marcar como atendida: ' + e.message));
    }
    function mostrarFormularioAlertaPrueba() {
      document.getElementById('formAlertaPrueba').style.display = '';
      document.getElementById('btnCrearAlertaPrueba').style.display = 'none';
    }
    function ocultarFormularioAlertaPrueba() {
      document.getElementById('formAlertaPrueba').style.display = 'none';
      document.getElementById('btnCrearAlertaPrueba').style.display = '';
    }
    function crearAlertaPrueba() {
      const usuario = document.getElementById('usuarioAlertaPrueba').value || 'prueba_' + Math.floor(Math.random()*10000);
      const lat = parseFloat(document.getElementById('latAlertaPrueba').value);
      const lng = parseFloat(document.getElementById('lngAlertaPrueba').value);
      if (isNaN(lat) || isNaN(lng)) { alert('Latitud y longitud inválidas'); return; }
      const alerta = {
        usuarioId: usuario,
        ubicacion: [lat, lng],
        estado: 'pendiente',
        timestamp: new Date().toISOString()
      };
      fetch('http://127.0.0.1:8000/alertas', {
        method: 'POST',
        headers: getHeaders(),
        body: JSON.stringify(alerta)
      }).then(() => { listarAlertas(); ocultarFormularioAlertaPrueba(); });
    }
    function initMap() {
      if (map) return;
      map = L.map('map').setView([0, -78.15], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);
    }
    // Login/logout
    firebase.auth().onAuthStateChanged(user => {
      if (user) user.getIdToken().then(token => { idToken = token; showMain(); });
      else showLogin();
    });
  </script>
  <!-- Login oculto pero funcional -->
  <div id="loginPage" class="login-bg" style="display:none;">
    <form class="login-box" onsubmit="event.preventDefault(); login();">
      <h2>Iniciar Sesión</h2>
      <input id="email" type="email" placeholder="Email" required>
      <input id="password" type="password" placeholder="Contraseña" required>
      <button type="submit">Entrar</button>
    </form>
  </div>
</body>
</html>
