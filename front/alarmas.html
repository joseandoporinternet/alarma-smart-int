<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Alarmas</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
</head>
<body>
  <div class="navbar">
    <a href="../front/index.html">Alertas</a>
    <a href="#" class="active">Alarmas</a>
  </div>
  <div class="main-layout">
    <div class="content">
      <div class="header">
        <h1>Gestión de Alarmas</h1>
        <div style="display: flex; gap: 10px; align-items: center;">
          <button id="btnNuevaAlarma" class="logout-btn" style="background:#2d8cf0;" onclick="toggleCrearAlarma()"><i class="fa fa-plus"></i> Crear nueva alarma</button>
          <button class="logout-btn" onclick="logout()"><i class="fa fa-sign-out-alt"></i> Cerrar sesión</button>
        </div>
      </div>
      <div class="main-layout" style="height:calc(100vh - 120px); display:flex; flex-direction:row; justify-content:center; align-items:flex-start; gap:32px;">
        <div style="flex:1; max-width:600px; min-width:280px; overflow-y:auto;">
          <div class="alarmas-grid" id="alarmasGrid"></div>
        </div>
        <div class="crear-alarma" id="crearAlarmaForm" style="display:none; min-width:260px; max-width:320px; background:#fff; box-shadow:0 2px 12px #0002; border-radius:8px; padding:24px 18px; margin-top:0;">
          <h3 id="formTitle">Crear Nueva Alarma</h3>
          <input id="alarmaId" placeholder="ID">
          <input id="alarmaDireccion" placeholder="Dirección">
          <select id="alarmaEstado">
            <option value="activo">Activo</option>
            <option value="inactivo">Inactivo</option>
          </select>
          <input id="alarmaLat" type="number" step="any" placeholder="Latitud">
          <input id="alarmaLng" type="number" step="any" placeholder="Longitud">
          <button id="btnGuardarAlarma" onclick="crearAlarma()">Crear Alarma</button>
          <button id="btnCancelarEdicion" style="display:none; background:#888; color:#fff; margin-top:8px;" onclick="cancelarEdicion()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Configuración Firebase
    // --- Firebase Configuración e Inicialización ---
const firebaseConfig = {
  apiKey: "AIzaSyDpHOc0setZG5aSqrbBvXZ-Yf0zkgNfrT0",
  authDomain: "controlledesp32-2afc2.firebaseapp.com",
  projectId: "controlledesp32-2afc2",
  storageBucket: "controlledesp32-2afc2.appspot.com",
  messagingSenderId: "873706050350",
  appId: "1:873706050350:web:d616c15e2649391d4720bf"
};
firebase.initializeApp(firebaseConfig);

// --- Variables Globales ---
let idToken = null;
let map;
let editandoId = null;

// --- Funciones Auxiliares ---
function getHeaders() {
  if (!idToken) throw new Error('No token');
  return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + idToken };
}

function logout() {
  firebase.auth().signOut();
  idToken = null;
  window.location.href = "../front/index.html";
}

function limpiarFormulario() {
  document.getElementById('formTitle').textContent = 'Crear Nueva Alarma';
  document.getElementById('alarmaId').value = '';
  document.getElementById('alarmaId').disabled = false;
  document.getElementById('alarmaDireccion').value = '';
  document.getElementById('alarmaEstado').value = 'activo';
  document.getElementById('alarmaLat').value = '';
  document.getElementById('alarmaLng').value = '';
  document.getElementById('btnGuardarAlarma').textContent = 'Crear Alarma';
  document.getElementById('btnCancelarEdicion').style.display = 'none';
  editandoId = null;
}

function cancelarEdicion() {
  limpiarFormulario();
  document.getElementById('crearAlarmaForm').style.display = 'none';
}

function toggleCrearAlarma() {
  const form = document.getElementById('crearAlarmaForm');
  form.style.display = form.style.display === 'none' ? '' : 'none';
  if (form.style.display === '') limpiarFormulario();
}

// --- Funciones de Alarmas ---
function listarAlarmas() {
  fetch('http://127.0.0.1:8000/alarmas', { headers: getHeaders() })
    .then(r => r.json())
    .then(data => {
      const grid = document.getElementById('alarmasGrid');
      grid.innerHTML = '';
      data.forEach(a => {
        const [lat, lng] = a.ubicacion;
        const card = document.createElement('div');
        card.className = 'alarma-card';
        card.innerHTML = `
          <b>${a.id}</b>
          <div>${a.direccion}</div>
          <div class='${a.estado === 'activo' ? 'estado-activo' : 'estado-inactivo'}'>${a.estado}</div>
          <div class='ubicacion'><i class='fa fa-map-marker-alt'></i> ${lat}, ${lng}</div>
          <button class='delete-btn' onclick='event.stopPropagation(); eliminarAlarma("${a.id}")'><i class="fa fa-trash"></i></button>
          <button class='delete-btn' style='background:#2d8cf0; right:50px;' onclick='event.stopPropagation(); editarAlarma("${a.id}")'><i class="fa fa-edit"></i></button>
        `;
        grid.appendChild(card);
      });
    });
}

function crearAlarma() {
  const alarma = {
    id: document.getElementById('alarmaId').value,
    direccion: document.getElementById('alarmaDireccion').value,
    estado: document.getElementById('alarmaEstado').value,
    ubicacion: [
      parseFloat(document.getElementById('alarmaLat').value),
      parseFloat(document.getElementById('alarmaLng').value)
    ]
  };

  const method = editandoId ? 'PUT' : 'POST';
  const url = editandoId ? `http://127.0.0.1:8000/alarmas/${editandoId}` : 'http://127.0.0.1:8000/alarmas';

  fetch(url, {
    method,
    headers: getHeaders(),
    body: JSON.stringify(alarma)
  })
    .then(r => r.json())
    .then(() => {
      listarAlarmas();
      if (editandoId) cancelarEdicion();
      else {
        limpiarFormulario();
        document.getElementById('crearAlarmaForm').style.display = 'none';
      }
    });
}

function eliminarAlarma(id) {
  if (!confirm(`¿Eliminar alarma ${id}?`)) return;
  fetch(`http://127.0.0.1:8000/alarmas/${id}`, {
    method: 'DELETE',
    headers: getHeaders()
  }).then(() => listarAlarmas());
}

function editarAlarma(id) {
  fetch(`http://127.0.0.1:8000/alarmas/${id}`, { headers: getHeaders() })
    .then(r => r.json())
    .then(a => {
      document.getElementById('formTitle').textContent = 'Editar Alarma';
      document.getElementById('alarmaId').value = a.id;
      document.getElementById('alarmaId').disabled = true;
      document.getElementById('alarmaDireccion').value = a.direccion;
      document.getElementById('alarmaEstado').value = a.estado;
      document.getElementById('alarmaLat').value = a.ubicacion[0];
      document.getElementById('alarmaLng').value = a.ubicacion[1];
      document.getElementById('btnGuardarAlarma').textContent = 'Guardar Cambios';
      document.getElementById('btnCancelarEdicion').style.display = '';
      document.getElementById('crearAlarmaForm').style.display = '';
      editandoId = a.id;
    });
}

// --- Inicio de sesión y carga de datos ---
firebase.auth().onAuthStateChanged(user => {
  if (user) user.getIdToken().then(token => {
    idToken = token;
    listarAlarmas();
  });
  else window.location.href = "../front/index.html";
});

  </script>
</body>
</html>
